// ============================================
// PRISMA SCHEMA - Database Models
// E-commerce Fee Calculator
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

/// Loại shop trên các sàn TMĐT
enum ShopType {
  NORMAL      // Shop thường (Non-Mall)
  MALL        // Shop Mall/Brand/Official
}

/// Trạng thái active của record
enum Status {
  ACTIVE
  INACTIVE
  DEPRECATED
}

// ============================================
// PLATFORMS - Các sàn TMĐT
// ============================================

/// Bảng lưu thông tin các sàn TMĐT (Shopee, TikTok, Lazada, etc.)
model Platform {
  id          String   @id @default(cuid())
  code        String   @unique /// shopee, tiktok, lazada
  name        String   /// Tên hiển thị
  logo        String?  /// URL logo
  color       String?  /// Brand color hex (#EE4D2D)
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  categories          Category[]
  baseFeeConfigs      BaseFeeConfig[]
  optionalFeeConfigs  OptionalFeeConfig[]
  
  @@map("platforms")
}

// ============================================
// CATEGORIES - Ngành hàng (cấp 1, 2, 3)
// ============================================

/// Bảng lưu ngành hàng - hỗ trợ cấu trúc phân cấp
/// Shopee có 3 cấp: Nhóm ngành → Ngành cấp 1 → Ngành cấp 2
model Category {
  id              String    @id @default(cuid())
  platformId      String
  parentId        String?   /// null = root category
  
  code            String    /// unique code: fashion, electronics
  name            String    /// Tên tiếng Việt
  level           Int       @default(1) /// 1, 2, 3
  
  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  platform        Platform   @relation(fields: [platformId], references: [id], onDelete: Cascade)
  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  
  // Fee configs for this category
  commissionRates CategoryCommissionRate[]
  
  @@unique([platformId, code])
  @@index([platformId, parentId])
  @@map("categories")
}

// ============================================
// CATEGORY COMMISSION RATES - Phí Cố Định theo ngành hàng
// ============================================

/// Phí Cố Định (Commission) = % theo giá sản phẩm, khác nhau theo:
/// - Ngành hàng (category)
/// - Loại shop (Mall vs Non-Mall)  
/// - Thời gian hiệu lực
model CategoryCommissionRate {
  id              String    @id @default(cuid())
  categoryId      String
  shopType        ShopType  @default(NORMAL)
  
  /// % phí cố định (đã bao gồm VAT)
  /// Ví dụ: 0.12 = 12%, 0.1178 = 11.78%
  rate            Decimal   @db.Decimal(6, 4)
  
  /// Phí tối thiểu/tối đa (VND) - optional
  minFee          Decimal?  @db.Decimal(12, 2)
  maxFee          Decimal?  @db.Decimal(12, 2)
  
  /// Thời gian hiệu lực
  effectiveFrom   DateTime  @default(now())
  effectiveTo     DateTime? /// null = không hết hạn
  
  status          Status    @default(ACTIVE)
  notes           String?   /// Ghi chú thêm
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  category        Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([categoryId, shopType, status])
  @@index([effectiveFrom, effectiveTo])
  @@map("category_commission_rates")
}

// ============================================
// BASE FEE CONFIGS - Phí cơ bản theo sàn
// ============================================

/// Các loại phí cơ bản áp dụng cho TẤT CẢ đơn hàng trên sàn
/// Không phụ thuộc ngành hàng, chỉ phụ thuộc loại shop
model BaseFeeConfig {
  id              String    @id @default(cuid())
  platformId      String
  shopType        ShopType  @default(NORMAL)
  
  // ========================================
  // PHÍ THANH TOÁN (Payment Fee)
  // ========================================
  /// % phí thanh toán (đã bao gồm VAT)
  /// Shopee Mall: 4.91%, Non-Mall: tương tự
  paymentFeeRate  Decimal   @db.Decimal(6, 4)
  
  // ========================================
  // METADATA
  // ========================================
  effectiveFrom   DateTime  @default(now())
  effectiveTo     DateTime?
  status          Status    @default(ACTIVE)
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  platform        Platform  @relation(fields: [platformId], references: [id], onDelete: Cascade)
  
  @@unique([platformId, shopType, effectiveFrom])
  @@index([platformId, shopType, status])
  @@map("base_fee_configs")
}

// ============================================
// OPTIONAL FEE CONFIGS - Phí dịch vụ tùy chọn
// ============================================

/// Các loại phí CHỈ áp dụng khi người bán THAM GIA dịch vụ
/// Ví dụ: Voucher Xtra, Đồng Tài Trợ, Content Xtra, Affiliate
model OptionalFeeConfig {
  id              String    @id @default(cuid())
  platformId      String
  shopType        ShopType  @default(NORMAL)
  
  /// Loại phí dịch vụ
  feeType         String    /// voucher_xtra, co_funding, content_xtra, affiliate
  feeName         String    /// Tên hiển thị
  description     String?   /// Mô tả chi tiết
  
  /// % phí (đã bao gồm VAT)
  rate            Decimal   @db.Decimal(6, 4)
  
  /// Phí tối đa (VND) - ví dụ Voucher Xtra max 50,000đ/sản phẩm
  maxFeePerItem   Decimal?  @db.Decimal(12, 2)
  
  /// Cách tính: 
  /// - "percentage" = % giá sản phẩm
  /// - "fixed" = số tiền cố định
  /// - "percentage_of_voucher" = % giá trị voucher (cho đồng tài trợ)
  calculationType String    @default("percentage")
  
  /// Điều kiện áp dụng (JSON)
  /// Ví dụ: {"excludeCategories": ["electronics"], "minOrderValue": 50000}
  conditions      Json?
  
  effectiveFrom   DateTime  @default(now())
  effectiveTo     DateTime?
  status          Status    @default(ACTIVE)
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  platform        Platform  @relation(fields: [platformId], references: [id], onDelete: Cascade)
  
  @@unique([platformId, shopType, feeType, effectiveFrom])
  @@index([platformId, feeType, status])
  @@map("optional_fee_configs")
}

// ============================================
// FEE POLICY VERSIONS - Lịch sử thay đổi chính sách phí
// ============================================

/// Lưu thông tin về các đợt thay đổi chính sách phí
/// Giúp tracking và audit
model FeePolicyVersion {
  id              String    @id @default(cuid())
  platformCode    String    /// shopee, tiktok
  
  version         String    /// v2025.12.29
  effectiveDate   DateTime
  title           String    /// "Cập nhật phí từ 29/12/2025"
  description     String?   /// Mô tả chi tiết thay đổi
  sourceUrl       String?   /// Link bài viết gốc từ sàn
  
  /// Snapshot dữ liệu (JSON) - backup toàn bộ config
  configSnapshot  Json?
  
  createdAt       DateTime  @default(now())
  
  @@unique([platformCode, version])
  @@map("fee_policy_versions")
}

// ============================================
// CALCULATION HISTORY - Lịch sử tính toán
// ============================================

/// Lưu lịch sử tính toán (optional, cho analytics)
model CalculationHistory {
  id              String    @id @default(cuid())
  sessionId       String?   /// Anonymous session
  
  // Input
  platformCode    String
  categoryCode    String
  shopType        ShopType
  productCost     Decimal   @db.Decimal(12, 2)
  sellingPrice    Decimal   @db.Decimal(12, 2)
  quantity        Int       @default(1)
  
  // Optional services used
  useVoucherXtra  Boolean   @default(false)
  useCoFunding    Boolean   @default(false)
  voucherAmount   Decimal?  @db.Decimal(12, 2)
  
  // Output
  totalFees       Decimal   @db.Decimal(12, 2)
  netProfit       Decimal   @db.Decimal(12, 2)
  profitMargin    Decimal   @db.Decimal(6, 4)
  
  // Full breakdown (JSON)
  feeBreakdown    Json
  
  createdAt       DateTime  @default(now())
  
  @@index([sessionId])
  @@index([createdAt])
  @@index([platformCode, categoryCode])
  @@map("calculation_history")
}
